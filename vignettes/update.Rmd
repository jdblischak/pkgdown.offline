---
title: "Update pkgdown.offline"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Update pkgdown.offline}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

pkgdown.offline needs to retrieve the cached frontend dependencies from
each pkgdown version (>= 2.1.0) and store them in the package.
Every time a new pkgdown version is released on CRAN, the new version support
should to be verified and potentially added by the developer. pkgdown.offline
also optimizes its package size by deduplicating these cache files across
different pkgdown versions.

## Retrieve raw pkgdown external dependencies

Open the package in development mode. Retrieve the raw pkgdown external
dependencies cache for all supported pkgdown versions. For example:

```r
path_cache <- file.path(tempdir(), "pkgdown.offline")
pkgdown.offline:::update_cache("2.1.0", destdir = path_cache)
pkgdown.offline:::update_cache("2.1.1", destdir = path_cache)
pkgdown.offline:::update_cache("2.1.2", destdir = path_cache)
```

## Create minified cache

Create a minified cache in pkgdown.offline:

```r
pkgdown.offline:::minify_cache(path_cache)
```

## Update offline build logic

Now the package contains the minified cache with deduplicated files in
`inst/cache/`. Commit and push.

Certain internet-skipping logic in `pkgdown.offline::build_site()` and
relevant functions might need adjustment.

## When the cache is used

When `pkgdown.offline::init_site()` or `pkgdown.offline::build_site()`
is called to initialize or build site offline, the `copy_to_cache()` function
will use `restore_cache()` to restore the cache into their original structure
to the regular pkgdown cache location that individual pkgdown versions expect.
